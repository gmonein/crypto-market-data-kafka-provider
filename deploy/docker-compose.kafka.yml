version: "3.9"

services:
  redpanda:
    image: redpandadata/redpanda:latest
    container_name: pm-market-data-redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - internal://0.0.0.0:9092
      - --advertise-kafka-addr
      - internal://redpanda:9092
    ports:
      - "9092:9092"
    volumes:
      - ../redpanda-data:/var/lib/redpanda/data
    networks:
      pm-market-data:
        aliases:
          - redpanda
    restart: unless-stopped

  redpanda-console:
    image: redpandadata/console:latest
    container_name: pm-market-data-console
    depends_on:
      - redpanda
    environment:
      KAFKA_BROKERS: redpanda:9092
    ports:
      - "8080:8080"
    networks:
      - pm-market-data
    restart: unless-stopped

  init-redpanda:
    image: redpandadata/redpanda:latest
    depends_on:
      - redpanda
    environment:
      SYMBOL: ${MARKET_SYMBOL:-BTCUSDT}
    entrypoint:
      - /bin/sh
      - -c
      - |
        SYMBOL="$${SYMBOL:-$${MARKET_SYMBOL:-$${PM_SYMBOL:-BTCUSDT}}}"; \
        SYMBOL="$$(printf "%s" "$$SYMBOL" | tr '[:lower:]' '[:upper:]' | tr -d '_/ -' )"; \
        if [ -z "$$SYMBOL" ]; then SYMBOL="BTCUSDT"; fi; \
        SYMBOL_LOWER="$$(printf "%s" "$$SYMBOL" | tr '[:upper:]' '[:lower:]' )"; \
        if [ -z "$$SYMBOL_LOWER" ]; then SYMBOL_LOWER="btcusdt"; fi; \
        BINANCE_TOPIC="binance_$${SYMBOL_LOWER}"; \
        BINANCE_VOLUME_TOPIC="binance_$${SYMBOL_LOWER}_volume"; \
        BINANCE_ORDERBOOK_TOPIC="binance_$${SYMBOL_LOWER}_orderbook"; \
        BYBIT_TOPIC="bybit_$${SYMBOL_LOWER}"; \
        BYBIT_VOLUME_TOPIC="bybit_$${SYMBOL_LOWER}_volume"; \
        BYBIT_ORDERBOOK_TOPIC="bybit_$${SYMBOL_LOWER}_orderbook"; \
        BITGET_TOPIC="bitget_$${SYMBOL_LOWER}"; \
        BITGET_VOLUME_TOPIC="bitget_$${SYMBOL_LOWER}_volume"; \
        BITGET_ORDERBOOK_TOPIC="bitget_$${SYMBOL_LOWER}_orderbook"; \
        OKX_TOPIC="okx_$${SYMBOL_LOWER}"; \
        OKX_VOLUME_TOPIC="okx_$${SYMBOL_LOWER}_volume"; \
        OKX_ORDERBOOK_TOPIC="okx_$${SYMBOL_LOWER}_orderbook"; \
        COINBASE_TOPIC="coinbase_$${SYMBOL_LOWER}"; \
        COINBASE_VOLUME_TOPIC="coinbase_$${SYMBOL_LOWER}_volume"; \
        COINBASE_ORDERBOOK_TOPIC="coinbase_$${SYMBOL_LOWER}_orderbook"; \
        KRAKEN_TOPIC="kraken_$${SYMBOL_LOWER}"; \
        KRAKEN_VOLUME_TOPIC="kraken_$${SYMBOL_LOWER}_volume"; \
        KRAKEN_ORDERBOOK_TOPIC="kraken_$${SYMBOL_LOWER}_orderbook"; \
        CHAINLINK_TOPIC="chainlink_$${SYMBOL_LOWER}"; \
        rpk topic create "$$BINANCE_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BINANCE_VOLUME_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BINANCE_ORDERBOOK_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BYBIT_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BYBIT_VOLUME_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BYBIT_ORDERBOOK_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BITGET_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BITGET_VOLUME_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$BITGET_ORDERBOOK_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$OKX_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$OKX_VOLUME_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$OKX_ORDERBOOK_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$COINBASE_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$COINBASE_VOLUME_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$COINBASE_ORDERBOOK_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$KRAKEN_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$KRAKEN_VOLUME_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$KRAKEN_ORDERBOOK_TOPIC" -X brokers=redpanda:9092 || true; \
        rpk topic create "$$CHAINLINK_TOPIC" -X brokers=redpanda:9092 || true; \
        true
    networks:
      - pm-market-data
    restart: "no"

networks:
  pm-market-data:
    name: pm-market-data
